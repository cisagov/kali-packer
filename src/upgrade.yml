---
- hosts: all
  name: Upgrade base image
  become: yes
  become_method: sudo
  tasks:
    # TODO: Remove this block once the upstream kernel bug is fixed.
    # See https://github.com/cisagov/kali-packer/issues/131 for more
    # details.
    #
    # There is currently a bug in the 6.x kernel that prevents ext4
    # filesystems from being online resized.
    #
    # Also note that dpkg/apt and aptitude use different mechanisms to
    # mark packages as held, so the safest thing to do is to mark it
    # both ways.
    - name: Prevent Linux kernel from being updated
      block:
        - name: Prevent Linux kernel from being updated via dpkg/apt
          ansible.builtin.dpkg_selections:
            name: linux-image-cloud-amd64
            selection: hold
        - name: Install aptitude
          ansible.builtin.package:
            force_apt_get: yes
            name:
              - aptitude
            update_cache: yes
        - name: Prevent Linux kernel from being updated via aptitude
          ansible.builtin.command:
            cmd: /usr/bin/aptitude hold linux-image-cloud-amd64
    - name: Upgrade
      ansible.builtin.import_role:
        name: upgrade
    # The base AMI currently ships with a 6.0.0 kernel, which as
    # described in #131 has a bug that does not allow ext4 filesystems
    # to be resized; therefore, it makes sense to go ahead and boot
    # into >=6.0.8 kernel installed in the previous upgrade step since
    # it does not have the bug.
    - name: Boot into the updated (>=6.0.8) kernel
      block:
        - name: Install kexec
          ansible.builtin.package:
            name:
              kexec-tools
        - name: Boot into the updated (>=6.0.8) kernel
          ansible.builtin.command:
            cmd: /usr/bin/systemctl kexec
